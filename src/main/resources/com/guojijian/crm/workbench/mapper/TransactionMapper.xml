<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guojijian.crm.workbench.mapper.TransactionMapper" >
  <resultMap id="BaseResultMap" type="com.guojijian.crm.workbench.pojo.Transaction" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    <id column="id" property="id" jdbcType="CHAR" />
    <result column="owner" property="owner" jdbcType="CHAR" />
    <result column="money" property="money" jdbcType="VARCHAR" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="expected_date" property="expectedDate" jdbcType="CHAR" />
    <result column="customer_id" property="customerId" jdbcType="CHAR" />
    <result column="stage" property="stage" jdbcType="VARCHAR" />
    <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="VARCHAR" />
    <result column="source" property="source" jdbcType="VARCHAR" />
    <result column="activity_id" property="activityId" jdbcType="CHAR" />
    <result column="contacts_id" property="contactsId" jdbcType="CHAR" />
    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
    <result column="create_date" property="createDate" jdbcType="CHAR" />
    <result column="edit_by" property="editBy" jdbcType="VARCHAR" />
    <result column="edit_date" property="editDate" jdbcType="CHAR" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="contact_summary" property="contactSummary" jdbcType="VARCHAR" />
    <result column="next_contact_date" property="nextContactDate" jdbcType="CHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    delete from tbl_tran
    where id = #{id,jdbcType=CHAR}
  </delete>

  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    select id, owner, money, name, expected_date, customer_id, stage, type, source, activity_id, 
    contacts_id, create_by, create_date, edit_by, edit_date, description, contact_summary, 
    next_contact_date
    from tbl_tran
  </select>

  <!--int insert(Transaction transaction);-->
  <insert id="insert" parameterType="com.guojijian.crm.workbench.pojo.Transaction" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    insert into tbl_tran (id, owner, money, name,expected_date, customer_id, stage, type, source, activity_id,
    contacts_id, create_by, create_date, description,contact_summary, next_contact_date)
    values (#{id,jdbcType=CHAR}, #{owner,jdbcType=CHAR}, #{money,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR},
    #{expectedDate,jdbcType=CHAR}, #{customerId,jdbcType=CHAR}, #{stage,jdbcType=VARCHAR},
    #{type,jdbcType=VARCHAR}, #{source,jdbcType=VARCHAR}, #{activityId,jdbcType=CHAR},
    #{contactsId,jdbcType=CHAR}, #{createBy,jdbcType=VARCHAR}, #{createDate,jdbcType=CHAR},
    #{description,jdbcType=VARCHAR},#{contactSummary,jdbcType=VARCHAR}, #{nextContactDate,jdbcType=CHAR})
  </insert>

  <!--List<Transaction> selectTranForPageByCondition(Transaction transaction);-->
  <select id="selectTranForPageByCondition" resultMap="BaseResultMap">
    SELECT t.id,u1.name owner,t.name,c2.name customer_id,v1.value stage,v2.value type,
    v3.value source,c1.fullname contacts_id
    FROM tbl_tran t
    JOIN tbl_user u1 ON u1.id=t.owner
    LEFT JOIN tbl_dic_value v1 ON v1.id=t.stage
    LEFT JOIN tbl_dic_value v2 ON v2.id=t.type
    LEFT JOIN tbl_dic_value v3 ON v3.id=t.source
    LEFT JOIN tbl_contacts c1 ON c1.id=t.contacts_id
    LEFT JOIN tbl_customer c2 ON c2.id=t.customer_id
    <where>
      <if test="owner!=null and owner!=''">
        AND u1.name LIKE '%' #{owner} '%'
      </if>
      <if test="name!=null and name!=''">
        AND t.name LIKE '%' #{name} '%'
      </if>
      <if test="customerId!=null and customerId!=''">
        AND c2.name LIKE '%' #{customerId} '%'
      </if>
      <if test="stage!=null and stage!=''">
        AND v1.value=#{stage}
      </if>
      <if test="type!=null and type!=''">
        AND v2.value=#{type}
      </if>
      <if test="source!=null and source!=''">
        AND v3.value=#{source}
      </if>
      <if test="contactsId!=null and contactsId!=''">
        AND c1.fullname LIKE '%' #{contactsId} '%'
      </if>
    </where>
  </select>

  <!--int deleteTranByIds(String[] ids);-->
  <delete id="deleteTranByIds">
    DELETE FROM tbl_tran WHERE id IN
    <foreach collection="array" item="id" separator="," open="(" close=")">
      #{id}
    </foreach>
  </delete>

  <!--Transaction selectTranForEditById(String id);-->
  <select id="selectTranForEditById" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    select t.id, t.owner, t.money, t.name, t.expected_date, c1.name customer_id, t.stage, t.type, t.source, t.activity_id,
    t.contacts_id, t.create_by, t.create_date, t.edit_by, t.edit_date, t.description, t.contact_summary, t.next_contact_date
    from tbl_tran t
    JOIN tbl_customer c1 ON c1.id=t.customer_id
    where t.id = #{id,jdbcType=CHAR}
  </select>

  <!--int updateTran(Transaction transaction);-->
  <update id="updateTran" parameterType="com.guojijian.crm.workbench.pojo.Transaction" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 07 09:51:42 CST 2023.
    -->
    update tbl_tran
    set owner = #{owner,jdbcType=CHAR},
    money = #{money,jdbcType=VARCHAR},
    name = #{name,jdbcType=VARCHAR},
    expected_date = #{expectedDate,jdbcType=CHAR},
    customer_id = #{customerId,jdbcType=CHAR},
    stage = #{stage,jdbcType=VARCHAR},
    type = #{type,jdbcType=VARCHAR},
    source = #{source,jdbcType=VARCHAR},
    activity_id = #{activityId,jdbcType=CHAR},
    contacts_id = #{contactsId,jdbcType=CHAR},
    create_by = #{createBy,jdbcType=VARCHAR},
    create_date = #{createDate,jdbcType=CHAR},
    edit_by = #{editBy,jdbcType=VARCHAR},
    edit_date = #{editDate,jdbcType=CHAR},
    description = #{description,jdbcType=VARCHAR},
    contact_summary = #{contactSummary,jdbcType=VARCHAR},
    next_contact_date = #{nextContactDate,jdbcType=CHAR}
    where id = #{id,jdbcType=CHAR}
  </update>

  <!--Transaction selectTranForDetailById(String id);-->
  <select id="selectTranForDetailById" resultMap="BaseResultMap">
    SELECT t.id, u1.name owner, t.money, t.name, t.expected_date, c1.name customer_id, d1.value stage,d1.order_no,
    d2.value type, d3.value source, a.name activity_id,c.fullname contacts_id, u2.name create_by,
    t.create_date, u3.name edit_by, t.edit_date, t.description, t.contact_summary, t.next_contact_date
    from tbl_tran t
    JOIN tbl_user u1 ON u1.id=t.owner
    JOIN tbl_user u2 ON u2.id=t.create_by
    LEFT JOIN tbl_user u3 ON u3.id=t.edit_by
    JOIN tbl_customer c1 ON c1.id=t.customer_id
    LEFT JOIN tbl_dic_value d1 ON d1.id=t.stage
    LEFT JOIN tbl_dic_value d2 ON d2.id=t.type
    LEFT JOIN tbl_dic_value d3 ON d3.id=t.source
    LEFT JOIN tbl_activity a ON a.id=t.activity_id
    LEFT JOIN tbl_contacts c ON c.id=t.contacts_id
    WHERE t.id=#{id}
  </select>

  <!--List<FunnelVN> selectTranCountGroupByStage();-->
  <select id="selectTranCountGroupByStage" resultType="com.guojijian.crm.commons.pojo.FunnelVN">
    SELECT COUNT(*) value,dv.value name
    FROM tbl_tran t
    JOIN tbl_dic_value dv ON dv.id=t.stage
    GROUP BY t.stage
  </select>

  <!--int updateTranStageById(Transaction transaction);-->
  <update id="updateTranStageById">
    UPDATE tbl_tran SET stage=#{stage},edit_by=#{editBy},edit_date=#{editDate}
    WHERE id=#{id}
  </update>
</mapper>